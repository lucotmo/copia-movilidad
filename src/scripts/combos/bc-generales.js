import { h, render } from "preact";

import "../base/footer";
import Shelf from "../components/Shelf";
import SearchBar from "../components/SerachBar";
import { login, logout } from "../global/helpers";
import { UserServices } from "../global/user";
import { SC_MIDDLE_URL } from "../global/constants";
const generalFunc = (() => {
    const init = () => {
        const urlSLParam = new URLSearchParams(window.location.search);
        const getSL = urlSLParam.get("SL");
        const validUser = UserServices.getUserData();

        if (getSL && !(validUser && validUser.isUserDefined)) login();
        if (typeof vtexjs !== "undefined") initUserData();
        handleSlickResize();
        changeBreadcrumb();
        handleLoginModal();
        handleSearchBar();
        handleShelf();
        logOutByTime();
        checkJws();
        // bannerStopPage();
    };

    /* const bannerStopPage = ()=>{
        const urlCurrent = window.location.href;
        const widthDocument = $(document).width()
        let domain = (new URL(urlCurrent));
        domain = domain.hostname;
        console.log('Doiman', domain);
        $(window).load(() => {
            if(domain === 'movilidadtu360.grupobancolombia.com'){
                
                if (widthDocument > 768) {
                    $('body').append(
                        `<div class="bannerStopPage">
                        <img src="/arquivos/mantenimiento_desk.png" alt="stop page"/>
                    </div>`);
                } else {
                    $('body').append(
                        `<div class="bannerStopPage">
                        <img src="/arquivos/mantenimiento_mob.png" alt="stop page"/>
                    </div>`);
                }
            }
        });
    } */

    const checkJws = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const jws = urlParams.get("jws");

        if (jws) login();
    };

    const logOutByTime = () => {
        const user = UserServices.getUserData();
        if (user && user.activeUntil && user.activeUntil < Date.now()) logout();
    };

    const handleSlickResize = () =>
        $(window).on("resize orientationchange", function () {
            $(".slick-initialized").each(function () {
                $(this).slick("resize");
            });
        });

    const changeBreadcrumb = () => {
        $(".breadcrumb ul li:nth-child(2) a").text("TU360Movilidad");
        $(".breadcrumb ul li").find('a[title="Carros"]').parent().remove();
    };

    const initUserData = () => {
        const loadUserMD = (orderForm, user) => fetch(`/api/dataentities/CL/search?email=${user.userEmail}&_fields=realEmail,firstName,lastName,phone,accessToken`)
            .then((res) => res.json())
            .then((res) => {
                if (res && res[0]) {
                    const { id } = UserServices.getUserIdInfo();
                    if (
                        !orderForm.clientProfileData ||
                        !orderForm.clientProfileData.document ||
                        (id && id != orderForm.clientProfileData.document)
                    ) {
                        const { id, idType } = UserServices.getUserIdInfo();
                        const ofUser = {
                            document: id,
                            documentType: idType,
                            email: res[0].realEmail,
                            firstName: res[0].firstName,
                            lastName: res[0].lastName,
                            phone: res[0].phone,
                        };
                        UserServices.setOFUserData(ofUser);
                    }
                    localStorage.setItem(
                        "userData",
                        JSON.stringify({ realEmail: res[0].realEmail, phone: res[0].phone, userToken: res[0].accessToken, ...user })
                    );
                }
            });

        vtexjs.checkout.getOrderForm().then(function (orderForm) {
            const user = UserServices.getUserData();
            if (user && user.isUserDefined && !user.realEmail) loadUserMD(orderForm, user);
            else UserServices.validateUser(() => {
                const user = UserServices.getUserData();
                loadUserMD(orderForm, user);
            });
        });
    }

    const handleSearchBar = () => {
        const container = document.querySelector(".js-search-bar");
        if (container) render(<SearchBar />, container);
    };

    const handleShelf = () => {
        const container = document.querySelector(".js-shelf");
        if (container) render(<Shelf />, container);
    };

    /* ******************* VALIDACIONES URL ******************* */


    /* ******************* END VALIDACIONES URL ******************* */
    const handleLoginModal = () => {
        const storeDataMutationCallback = (mutationList) => {
            mutationList = mutationList[0];
            const removedNodes = mutationList.removedNodes;
            const addedNodes = mutationList.addedNodes;
            if (removedNodes.length > 0) {
                const user = UserServices.getUserData();
                for (let i = 0; i < removedNodes.length; i++) {
                    const node = removedNodes[i];
                    // User isn't defined and login modal was close
                    if (node.nodeType === 1 && node.getAttribute("id") === "vtexIdContainer" && !(user && user.isDefined)) {
                        UserServices.validateUser(() => {
                            const urlParams = new URLSearchParams(window.location.search);
                            const redirectUrl = urlParams.get("redirectUrl");
                            if (redirectUrl) window.location.href = redirectUrl;
                            else window.location.reload();
                        });
                    }
                }
            }

            if (addedNodes.length > 0) {
                for (let i = 0; i < addedNodes.length; i++) {
                    const node = addedNodes[i];
                    if (node.nodeType === 1 && node.getAttribute("id") === "vtexIdContainer") {
                        const modalBody = $("#vtexIdUI-auth-selector .modal-body");

                        $("#loginWithAccessKeyBtn").parent().remove();
                        $("#loginWithUserAndPasswordBtn").parent().remove();
                        $(".vtexIdUI-close").html('<i class="fenix-icon-error"></i>');
                        modalBody.prepend(`
                            <div class="bc-login">
                                <svg viewBox="0 0 320 129" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M7.82227 127.285C7.82227 110.226 21.7129 96.4149 38.8301 96.4149C55.9655 96.4149 69.8379 110.244 69.8379 127.285" fill="#FF7F41"/>
                                    <path d="M59.6836 127.284C59.6836 119.135 66.319 112.53 74.5039 112.53C82.6888 112.53 89.3242 119.135 89.3242 127.284" fill="#FF7F41"/>
                                    <path d="M84.6211 127.285C84.6211 114.146 95.3216 103.493 108.52 103.493C121.717 103.493 132.418 114.146 132.418 127.285" fill="#FF7F41"/>
                                    <path d="M178.229 127.285C178.229 110.226 192.119 96.4149 209.236 96.4149C226.354 96.4149 240.244 110.244 240.244 127.285" fill="#9063CD"/>
                                    <path d="M212.39 127.284C212.39 116.377 221.268 107.539 232.223 107.539C243.179 107.539 252.057 116.395 252.057 127.284" fill="#9063CD"/>
                                    <path d="M242.066 127.285C242.066 118.646 249.103 111.659 257.762 111.659C266.421 111.659 273.457 118.664 273.457 127.285" fill="#9063CD"/>
                                    <path d="M165.796 127.285C165.796 121.84 170.243 117.412 175.712 117.412C181.181 117.412 185.629 121.84 185.629 127.285" fill="#9063CD"/>
                                    <path d="M1.00455 128.991H318.958C319.468 128.991 319.869 128.592 319.869 128.083C319.869 127.575 319.468 127.176 318.958 127.176H1.00455C0.494141 127.176 0.0931091 127.575 0.0931091 128.083C0.0931091 128.592 0.494141 128.991 1.00455 128.991Z" fill="#00C389"/>
                                    <path d="M245.658 58.5939H291.851C291.906 58.1947 291.924 57.7954 291.924 57.378C291.924 51.7339 287.33 47.1606 281.661 47.1606C281.26 47.1606 280.877 47.1787 280.494 47.2332C279.765 42.1698 275.408 38.2861 270.122 38.2861C265.273 38.2861 261.208 41.5528 260.005 45.9991C259.312 45.7632 258.564 45.6361 257.781 45.6361C254.025 45.6361 250.981 48.6669 250.981 52.4054C250.981 52.7139 250.999 53.0225 251.036 53.331C251.018 53.331 250.999 53.331 250.981 53.331C248.028 53.2947 245.658 55.6721 245.658 58.5939Z" fill="#59CBE8"/>
                                    <path d="M62.0169 40.5368H161.074C161.074 34.8745 156.462 30.2831 150.775 30.2831C150.374 30.2831 149.991 30.3012 149.608 30.3557C147.767 23.3868 141.387 18.2508 133.822 18.2508C133.566 18.2508 133.329 18.2508 133.074 18.269C129.41 10.556 121.517 5.22046 112.366 5.22046C102.085 5.22046 93.3711 11.9897 90.4909 21.2816C84.7304 22.0257 79.8268 25.5464 77.2018 30.4464C76.5091 30.3375 75.8164 30.2831 75.1055 30.2831C68.7617 30.2831 63.4388 34.6568 62.0169 40.5368Z" fill="#F5B6CD"/>
                                    <path d="M214.96 27.8507C207.52 27.8507 201.489 21.8462 201.489 14.4392C201.489 7.03224 207.52 1.02771 214.96 1.02771C222.4 1.02771 228.432 7.03224 228.432 14.4392C228.432 21.8462 222.4 27.8507 214.96 27.8507Z" fill="#FF7F41"/>
                                    <path d="M316.314 94.2546C316.933 94.2546 317.572 94.055 318.1 93.6557C319.376 92.6757 319.613 90.8428 318.629 89.5905C316.332 86.6324 313.124 84.4728 309.077 83.1842C305.704 82.1135 301.84 81.6961 297.902 81.9683C293.801 82.2587 289.827 83.1479 285.98 84.019C283.191 84.6542 280.566 85.235 277.868 85.6161C272.801 86.342 265.746 86.3602 260.97 82.3857C259.73 81.3513 257.889 81.5146 256.868 82.7487C255.829 83.9828 255.993 85.8157 257.233 86.832C263.668 92.1857 272.454 92.2402 278.707 91.3691C281.624 90.9516 284.504 90.3165 287.275 89.6813C291.066 88.8283 294.657 88.0116 298.322 87.7576C305.176 87.2857 311.045 89.3002 314.035 93.1476C314.582 93.8735 315.457 94.2546 316.314 94.2546Z" fill="#FDDA24"/>
                                    <path d="M273.112 86.996C277.815 86.996 281.261 85.9434 281.425 85.9071C282.537 85.5623 283.157 84.4008 282.81 83.2938C282.464 82.1867 281.297 81.5697 280.185 81.9145C280.149 81.9327 276.776 82.9308 272.401 82.8219C266.714 82.6767 262.047 80.7893 258.511 77.2504C257.69 76.4338 256.378 76.4156 255.539 77.2323C254.719 78.049 254.701 79.3556 255.521 80.1904C259.805 84.5097 265.657 86.869 272.42 87.0141C272.657 86.996 272.875 86.996 273.112 86.996Z" fill="#F5B6CD"/>
                                    <path d="M317.591 100.861C317.846 100.861 318.102 100.806 318.357 100.716C319.432 100.298 319.961 99.0822 319.542 98.0115C315.404 87.5218 306.162 85.9792 305.779 85.9066C304.63 85.7252 303.555 86.5055 303.391 87.6489C303.208 88.7922 303.992 89.8448 305.123 90.0263C305.432 90.0807 312.414 91.3511 315.641 99.5359C315.969 100.353 316.753 100.861 317.591 100.861Z" fill="#00C389"/>
                                    <path d="M221.104 95.4709L224.021 124.726C224.167 126.159 225.443 127.194 226.883 127.049C228.232 126.922 229.234 125.778 229.234 124.454L229.216 95.0535C229.216 92.8213 227.393 91.0065 225.151 91.0065C222.909 91.0065 221.086 92.8213 221.086 95.0535C221.086 95.1987 221.086 95.3439 221.104 95.4709Z" fill="#2C2A29"/>
                                    <path d="M216.109 94.6543L212.354 124.145C212.172 125.597 213.192 126.904 214.651 127.085C216.018 127.248 217.257 126.359 217.567 125.052L224.112 96.0336C224.604 93.8558 223.218 91.678 221.031 91.188C218.843 90.698 216.656 92.0773 216.164 94.255C216.145 94.3821 216.127 94.5273 216.109 94.6543Z" fill="#2C2A29"/>
                                    <path d="M209.875 98.4652C210.513 98.4652 211.042 97.9571 211.06 97.3037C211.26 87.3404 218.443 85.58 218.753 85.5074C219.391 85.3622 219.792 84.7271 219.646 84.0919C219.5 83.4567 218.88 83.0574 218.242 83.2026C218.151 83.2208 215.818 83.747 213.503 85.7615C211.388 87.5945 208.836 91.0789 208.708 97.2493C208.69 97.9026 209.219 98.4471 209.875 98.4471C209.857 98.4652 209.857 98.4652 209.875 98.4652Z" fill="#9063CD"/>
                                    <path d="M208.289 101.078C208.325 101.078 208.362 101.078 208.38 101.078C208.818 101.024 209.128 100.624 209.073 100.189C208.708 97.2852 208.891 94.6355 209.62 92.2944C209.747 91.877 209.51 91.4415 209.091 91.2963C208.672 91.1693 208.234 91.4052 208.088 91.8226C207.286 94.3815 207.086 97.2489 207.487 100.37C207.542 100.788 207.888 101.078 208.289 101.078Z" fill="#00C389"/>
                                    <path d="M212.391 86.9044C212.592 86.9044 212.81 86.8318 212.956 86.6685C215.271 84.2911 217.769 83.4199 217.787 83.4199C218.206 83.2748 218.425 82.8211 218.279 82.4218C218.133 82.0044 217.696 81.7866 217.276 81.9318C217.167 81.9681 214.414 82.9118 211.808 85.5796C211.498 85.8881 211.516 86.3962 211.826 86.7048C211.99 86.8318 212.191 86.9044 212.391 86.9044Z" fill="#00C389"/>
                                    <path d="M222.909 98.3558H222.034C218.479 98.3558 215.617 95.4884 215.617 91.9676V91.3869H229.344V91.9676C229.344 95.4884 226.464 98.3558 222.909 98.3558Z" fill="#2C2A29"/>
                                    <path d="M227.867 76.488L230.711 94.3821L213.831 96.7413C213.831 96.7413 212.117 76.7058 227.867 76.488Z" fill="#F5B6CD"/>
                                    <path d="M226.408 80.0265C226.572 80.0265 226.736 79.9902 226.9 79.9176C226.991 79.8813 229.142 78.865 230.965 76.3787C232.624 74.1283 234.356 70.172 233.116 64.1287C232.988 63.4935 232.369 63.0761 231.712 63.2031C231.074 63.3302 230.655 63.9472 230.783 64.6005C232.77 74.3642 226.152 77.6491 225.879 77.7761C225.296 78.0483 225.04 78.7561 225.314 79.3368C225.551 79.7724 225.97 80.0265 226.408 80.0265Z" fill="#9063CD"/>
                                    <path d="M234.101 70.0268C234.52 70.0268 234.866 69.7183 234.885 69.3009C235.103 66.6331 234.666 63.7838 233.59 60.8257C233.445 60.4083 232.989 60.2086 232.57 60.3538C232.15 60.499 231.932 60.9527 232.096 61.3701C233.08 64.1105 233.481 66.742 233.299 69.192C233.262 69.6275 233.59 70.0086 234.028 70.0449C234.046 70.0268 234.083 70.0268 234.101 70.0268Z" fill="#59CBE8"/>
                                    <path d="M227.703 81.097C227.848 81.097 227.994 81.0607 228.122 80.9881C228.231 80.9337 230.71 79.4093 232.661 76.2333C232.898 75.8522 232.77 75.3804 232.406 75.1445C232.023 74.9085 231.549 75.0356 231.312 75.3985C229.58 78.2296 227.338 79.6089 227.32 79.627C226.937 79.863 226.828 80.3348 227.065 80.7159C227.174 80.9518 227.429 81.097 227.703 81.097Z" fill="#59CBE8"/>
                                    <path d="M111.163 84.8543C111.291 84.8543 111.419 84.8361 111.546 84.7998C115.283 83.8561 118.656 81.6602 121.044 78.6476C123.432 75.6169 124.762 71.8421 124.799 67.9947C124.799 67.1236 124.106 66.4158 123.249 66.4158C122.374 66.4158 121.663 67.1054 121.663 67.9584C121.627 71.1161 120.533 74.2195 118.583 76.7058C116.632 79.192 113.861 80.9887 110.781 81.7509C109.942 81.9687 109.432 82.8217 109.65 83.6565C109.814 84.3824 110.452 84.8543 111.163 84.8543Z" fill="#F5B6CD"/>
                                    <path d="M107.263 127.194C108.284 127.194 109.286 126.722 109.906 125.815C115.156 118.32 112.914 100.843 112.659 98.8829C112.422 97.1225 110.781 95.9066 109.031 96.1425C107.263 96.3784 106.042 97.9936 106.279 99.754C107.172 106.233 107.518 118.029 104.638 122.131C103.617 123.583 103.982 125.579 105.44 126.595C105.969 127.013 106.625 127.194 107.263 127.194Z" fill="#2C2A29"/>
                                    <path d="M116.651 127.194C118.182 127.194 119.55 126.105 119.823 124.545C122.266 110.716 118.182 98.7741 118 98.266C117.417 96.5964 115.576 95.7071 113.898 96.2878C112.221 96.8686 111.328 98.7015 111.911 100.371C111.984 100.553 115.612 111.333 113.479 123.419C113.169 125.162 114.336 126.831 116.086 127.14C116.286 127.194 116.469 127.194 116.651 127.194Z" fill="#2C2A29"/>
                                    <path d="M104.771 76.7094C103.207 75.2192 103.051 72.8549 104.423 71.4285C105.794 70.0021 108.173 70.0538 109.737 71.5439C111.301 73.0341 111.457 75.3984 110.085 76.8248C108.714 78.2512 106.334 78.1995 104.771 76.7094Z" fill="#B28038"/>
                                    <path d="M72.3389 76.7116C70.7752 75.2215 70.6194 72.8572 71.9909 71.4308C73.3624 70.0044 75.7418 70.0561 77.3054 71.5462C78.8691 73.0363 79.0249 75.4006 77.6534 76.827C76.282 78.2534 73.9026 78.2017 72.3389 76.7116Z" fill="#E4AC7B"/>
                                    <path d="M116.378 79.646C116.505 79.646 116.633 79.6097 116.761 79.5371C119.313 78.1034 121.136 74.1109 121.208 73.9475C121.391 73.5483 121.208 73.0946 120.807 72.9131C120.406 72.7316 119.951 72.9131 119.768 73.3124C119.75 73.3487 118.073 76.9964 115.995 78.176C115.612 78.3938 115.484 78.8657 115.703 79.2468C115.831 79.5008 116.104 79.646 116.378 79.646Z" fill="#9063CD"/>
                                    <path d="M102.742 80.6073V102.131H120.406C120.388 102.131 122.265 79.6998 102.742 80.6073Z" fill="#E6DCCB"/>
                                    <path d="M95.1762 98.8648C95.9236 98.8648 96.5981 98.3204 96.7257 97.5582C97.5825 92.5493 101.192 88.0485 105.895 86.1067C106.697 85.78 107.08 84.8545 106.752 84.056C106.424 83.2574 105.494 82.8763 104.692 83.203C99.0043 85.5622 94.6658 90.9704 93.6268 97.0137C93.4809 97.8667 94.0642 98.6834 94.921 98.8286C95.0122 98.8648 95.1033 98.8648 95.1762 98.8648Z" fill="#59CBE8"/>
                                    <path d="M122.266 77.9939C122.466 77.9939 122.667 77.9213 122.812 77.7762C123.651 76.9595 124.38 75.4713 125 73.3661C125.456 71.8417 125.674 70.5713 125.674 70.5169C125.747 70.0995 125.456 69.6821 125.036 69.6095C124.599 69.5369 124.198 69.8272 124.125 70.2447C123.888 71.5876 123.013 75.3624 121.7 76.651C121.391 76.9595 121.391 77.4495 121.7 77.758C121.846 77.9213 122.047 77.9939 122.266 77.9939Z" fill="#FDDA24"/>
                                    <path d="M97.1453 96.7773C97.5463 96.7773 97.8927 96.4688 97.9291 96.0695C98.1114 94.2547 100.007 91.7322 100.718 90.9155C101.01 90.5888 100.973 90.0988 100.645 89.8085C100.317 89.5181 99.825 89.5544 99.5333 89.8811C99.4057 90.0081 96.6349 93.2384 96.3614 95.9062C96.325 96.3418 96.6349 96.7229 97.0724 96.7592C97.0906 96.7773 97.1088 96.7773 97.1453 96.7773Z" fill="#9063CD"/>
                                    <path d="M97.1273 89.8265C97.3825 89.8265 97.6377 89.6995 97.8018 89.4635C99.5883 86.6324 104.091 84.4002 104.127 84.382C104.51 84.1824 104.674 83.7287 104.492 83.3294C104.291 82.9483 103.836 82.785 103.435 82.9665C103.234 83.0572 98.4945 85.4165 96.4711 88.6287C96.2341 88.9917 96.3435 89.4817 96.7263 89.6995C96.8356 89.7721 96.9815 89.8265 97.1273 89.8265Z" fill="#FDDA24"/>
                                    <path d="M218.338 74.3247C216.967 72.8983 217.123 70.534 218.687 69.0439C220.25 67.5537 222.63 67.5021 224.001 68.9285C225.373 70.3548 225.217 72.7192 223.653 74.2093C222.089 75.6994 219.71 75.7511 218.338 74.3247Z" fill="#E4AC7B"/>
                                    <path d="M214.96 27.8517C207.52 27.8517 201.489 21.8471 201.489 14.4402C201.489 7.03322 207.52 1.02869 214.96 1.02869C222.4 1.02869 228.432 7.03322 228.432 14.4402C228.432 21.8471 222.4 27.8517 214.96 27.8517Z" fill="#FDDA24"/>
                                    <path d="M214.961 27.9414C222.435 27.9414 228.523 21.88 228.523 14.4392C228.523 6.99849 222.435 0.937012 214.961 0.937012C207.487 0.937012 201.398 6.99849 201.398 14.4392C201.398 21.88 207.487 27.9414 214.961 27.9414ZM214.961 1.11849C222.344 1.11849 228.341 7.08923 228.341 14.4392C228.341 21.7892 222.344 27.76 214.961 27.76C207.578 27.76 201.581 21.7892 201.581 14.4392C201.581 7.08923 207.578 1.11849 214.961 1.11849Z" fill="#FDDA24"/>
                                    <path d="M214.961 22.1706C210.672 22.1706 207.195 18.7092 207.195 14.4394C207.195 10.1697 210.672 6.70831 214.961 6.70831C219.25 6.70831 222.727 10.1697 222.727 14.4394C222.727 18.7092 219.25 22.1706 214.961 22.1706Z" fill="#FF7F41"/>
                                    <path d="M146.31 67.341C146.857 67.341 147.404 67.3228 147.951 67.3047C149.682 67.2139 151.432 66.978 153.31 66.5969C154.422 66.3791 155.151 65.2902 154.914 64.1832C154.695 63.0761 153.602 62.3502 152.49 62.5861C150.831 62.9309 149.263 63.1306 147.732 63.2032C141.534 63.548 135.828 61.5698 132.474 57.9402C131.708 57.1054 130.396 57.0509 129.557 57.8313C128.719 58.5935 128.664 59.9002 129.448 60.735C133.367 64.9635 139.456 67.341 146.31 67.341Z" fill="#59CBE8"/>
                                    <path d="M165.614 62.5317C165.87 62.5317 166.125 62.4772 166.38 62.3865C166.817 62.205 167.273 62.0417 167.711 61.8602C172.833 59.8276 178.12 57.7405 183.497 56.9602C192.101 55.7261 197.278 58.4665 199.594 60.2087C200.505 60.8983 201.799 60.7168 202.474 59.8094C203.166 58.902 202.984 57.6135 202.073 56.942C197.169 53.2579 190.37 51.8424 182.896 52.9131C177.026 53.7661 171.502 55.9439 166.161 58.0672C165.724 58.2487 165.286 58.412 164.849 58.5935C163.791 59.0109 163.281 60.2087 163.7 61.2613C164.01 62.0417 164.794 62.5317 165.614 62.5317Z" fill="#59CBE8"/>
                                    <path d="M206.922 62.0779C207.432 62.0779 207.943 61.8964 208.362 61.5334C209.237 60.7349 209.31 59.3919 208.508 58.5208C208.198 58.1942 200.961 50.3542 190.224 49.9186C189.039 49.8642 188.036 50.7897 187.982 51.9694C187.927 53.149 188.857 54.1471 190.042 54.2016C198.992 54.5645 205.245 61.3338 205.318 61.4064C205.755 61.842 206.338 62.0779 206.922 62.0779Z" fill="#9063CD"/>
                                    <path d="M147.076 64.8911C152.49 64.8911 156.282 63.2215 157.904 62.3322C158.907 61.7878 159.271 60.5356 158.724 59.5556C158.178 58.5574 156.92 58.1945 155.935 58.7389C154.204 59.6826 149.409 61.7334 142.355 60.2997C141.243 60.0819 140.149 60.7897 139.93 61.8967C139.711 63.0037 140.422 64.0926 141.534 64.3104C143.503 64.7096 145.362 64.8911 147.076 64.8911Z" fill="#FDDA24"/>
                                    <path d="M165.615 64.6183C165.907 64.6183 166.18 64.5457 166.454 64.4005C170.045 62.495 179.56 59.2464 179.652 59.2283C180.581 58.9198 181.092 57.9035 180.764 56.9598C180.454 56.0342 179.433 55.5261 178.485 55.8527C178.084 55.9979 168.605 59.2101 164.758 61.2609C163.883 61.7327 163.555 62.8035 164.029 63.6746C164.357 64.2735 164.977 64.6183 165.615 64.6183Z" fill="#FF7F41"/>
                                    <path d="M70.8047 61.098C71.6068 61.098 72.3907 60.6988 72.8282 59.9547C73.4844 58.8476 73.1198 57.4139 72.0079 56.7606C67.2865 53.9658 61.9089 52.0965 56.4401 51.3162C55.1641 51.1347 53.961 52.0239 53.7787 53.2943C53.5964 54.5647 54.4896 55.7625 55.7656 55.9439C60.6146 56.6336 65.4089 58.3032 69.5834 60.7714C69.9844 60.9891 70.4037 61.098 70.8047 61.098Z" fill="#F5B6CD"/>
                                    <path d="M66.7579 55.9255C67.4141 55.9255 68.0339 55.5444 68.3074 54.8911C68.6537 54.0381 68.2527 53.0581 67.3959 52.7133C64.1876 51.3885 60.8516 50.4448 57.4974 49.9003C54.0886 49.3559 50.625 49.2107 47.2162 49.4648C46.2865 49.5374 45.5938 50.3359 45.6667 51.2614C45.7396 52.187 46.5417 52.8766 47.4713 52.804C50.6432 52.5681 53.8334 52.7133 56.987 53.2033C60.086 53.6933 63.1667 54.5825 66.1381 55.7985C66.3204 55.8892 66.5391 55.9255 66.7579 55.9255Z" fill="#FDDA24"/>
                                    <path d="M19.1615 65.7258C19.5625 65.7258 19.9636 65.635 20.3282 65.4172C22.2605 64.3283 24.1198 63.058 25.9245 61.8239C26.4167 61.4972 26.8907 61.1706 27.3829 60.8439C28.3126 60.2087 29.5522 59.392 30.8282 58.648C32.1407 57.8857 33.3074 57.2869 34.4011 56.7969C35.586 56.2706 36.1147 54.8913 35.586 53.7117C35.0574 52.532 33.6719 52.0057 32.487 52.532C31.2475 53.0946 29.9167 53.7661 28.4584 54.6191C27.073 55.4357 25.7605 56.3069 24.7579 56.9602C24.2657 57.2869 23.7553 57.6317 23.2631 57.9583C21.4584 59.1924 19.7448 60.3358 17.9766 61.352C16.8464 61.9872 16.4636 63.4209 17.1016 64.5461C17.5391 65.3084 18.3412 65.7258 19.1615 65.7258Z" fill="#F5B6CD"/>
                                    <path d="M41.7112 56.2157C41.857 56.2157 42.0029 56.1976 42.1669 56.1613C45.3206 55.4354 48.5836 55.1268 51.8466 55.2539C52.9585 55.2902 53.8882 54.4191 53.9247 53.3302C53.9611 52.2231 53.0861 51.2976 51.9924 51.2613C48.383 51.1343 44.7737 51.4791 41.2737 52.2776C40.1982 52.5317 39.5055 53.6024 39.7607 54.6731C39.9612 55.5987 40.7815 56.2157 41.7112 56.2157Z" fill="#00C389"/>
                                    <path d="M28.9688 62.0051C29.4063 62.0051 29.8438 61.8781 30.2448 61.6421C30.974 61.1703 31.5938 60.7892 32.1771 60.4625C32.8334 60.0996 33.4714 59.7366 34.1276 59.4099L34.1459 59.3918C35.4584 58.7384 36.8256 58.1577 38.2292 57.6495C39.4506 57.214 40.0886 55.871 39.6511 54.6732C39.2136 53.4573 37.8647 52.8221 36.6615 53.2577C35.0938 53.8203 33.5443 54.4736 32.0677 55.2177C31.3021 55.5988 30.5547 55.9981 29.8802 56.3973L29.862 56.4155C29.224 56.7966 28.5495 57.1958 27.7474 57.7221C26.6536 58.4118 26.3437 59.8636 27.0365 60.9525C27.4375 61.624 28.1849 62.0051 28.9688 62.0051Z" fill="#FF7F41"/>
                                    <path d="M10.4478 70.2624C10.4843 70.2624 10.539 70.2624 10.5755 70.2624C13.2734 70.0627 16.026 69.2824 18.7786 67.9757C21.3124 66.7598 23.6275 65.2535 25.5963 63.9286C26.3619 63.4205 26.5624 62.3679 26.052 61.6057C25.5416 60.8434 24.4843 60.6438 23.7187 61.152C21.8593 62.4042 19.6718 63.8379 17.3385 64.9631C14.9687 66.0883 12.6171 66.7598 10.3385 66.9231C9.40878 66.9957 8.71607 67.7942 8.78899 68.7198C8.84368 69.609 9.57284 70.2624 10.4478 70.2624Z" fill="#59CBE8"/>
                                    <path d="M9.2633 68.7747C10.7399 68.7747 12.2893 68.5569 13.9664 68.1214C15.2242 67.7947 15.9716 66.5243 15.6435 65.2721C15.3154 64.0199 14.0393 63.2758 12.7815 63.6025C11.2503 64.0017 9.91956 64.1469 8.69821 64.0925H8.66176C7.42218 64.038 6.18258 63.7295 5.08884 63.1851C3.92217 62.6043 2.51855 63.0762 1.93522 64.2376C1.35188 65.3991 1.82583 66.7965 2.99249 67.3773C4.6878 68.2121 6.58364 68.7021 8.47947 68.7747C8.73467 68.7565 9.0081 68.7747 9.2633 68.7747Z" fill="#9063CD"/>
                                    <path d="M87.8486 94.3821C87.9397 94.3821 88.0126 94.3639 88.1038 94.3458C88.5048 94.2006 88.7235 93.765 88.5777 93.3658C87.1194 89.2098 83.4554 85.1265 83.2913 84.9631C82.9996 84.6365 82.5075 84.6183 82.1976 84.9087C81.8694 85.1991 81.8512 85.6891 82.1429 85.9976C82.1794 86.0339 85.7705 90.0265 87.1194 93.8739C87.2105 94.1824 87.5204 94.3821 87.8486 94.3821Z" fill="#FF7F41"/>
                                    <path d="M87.4097 99.2637C87.4644 99.2637 87.5191 99.2637 87.592 99.2456C88.1571 99.1548 88.5399 98.6104 88.4305 98.0478C87.2821 91.3874 83.1441 85.2715 77.3654 81.6963C76.8732 81.3878 76.2352 81.5511 75.9253 82.023C75.6154 82.513 75.7795 83.1482 76.2534 83.4567C81.5217 86.7233 85.3133 92.2948 86.3706 98.3926C86.48 98.9008 86.9175 99.2637 87.4097 99.2637Z" fill="#FDDA24"/>
                                    <path d="M68.9811 80.7344L75.8717 96.1422L81.9056 96.8319C81.9238 96.8319 89.9628 74.074 68.9811 80.7344Z" fill="#59CBE8"/>
                                    <path d="M74.2309 127.248C75.033 127.248 75.7622 126.686 75.908 125.869C75.9444 125.706 79.0616 109.536 80.283 100.679C80.4106 99.7537 79.7543 98.8826 78.8246 98.7555C77.895 98.6285 77.02 99.2818 76.8924 100.207C75.6892 108.973 72.5721 125.052 72.5539 125.216C72.3716 126.141 72.9914 127.03 73.921 127.212C74.0122 127.23 74.1215 127.248 74.2309 127.248Z" fill="#9063CD"/>
                                    <path d="M72.9727 104.817C72.9727 104.817 71.97 113.274 68.2513 118.537L72.9727 104.817Z" fill="white"/>
                                    <path d="M68.2518 119.789C68.6528 119.789 69.0539 119.608 69.2909 119.245C73.1555 113.8 74.1945 105.307 74.2492 104.944C74.3404 104.254 73.83 103.619 73.1372 103.529C72.4445 103.438 71.8065 103.946 71.7153 104.636C71.6971 104.708 70.6945 112.838 67.2127 117.775C66.8117 118.356 66.9393 119.136 67.5226 119.553C67.7414 119.717 67.9966 119.789 68.2518 119.789Z" fill="#00C389"/>
                                    <path d="M65.0992 128.192C65.5367 128.192 65.956 128.028 66.3023 127.702C73.6305 120.587 76.3102 105.397 76.4196 104.744C76.5836 103.819 75.9456 102.929 75.0159 102.766C74.0862 102.603 73.193 103.238 73.0289 104.163C73.0107 104.309 70.4222 118.9 63.8961 125.252C63.2216 125.905 63.2033 126.994 63.8596 127.665C64.206 128.01 64.6617 128.192 65.0992 128.192Z" fill="#FDDA24"/>
                                    <path d="M71.4785 83.0392C71.9342 83.0392 72.3535 82.7489 72.4811 82.277C72.6451 81.7326 72.317 81.1518 71.7701 81.0066C69.3821 80.3352 67.2675 78.847 65.8092 76.8326C64.3691 74.8181 63.6582 72.3318 63.804 69.8637C63.8222 69.41 63.8952 68.9744 63.9863 68.557C64.1139 67.9944 63.7493 67.45 63.1842 67.3229C62.6191 67.1959 62.0722 67.5589 61.9446 68.1214C61.8353 68.6477 61.7624 69.1922 61.7259 69.7366C61.5436 72.6766 62.4004 75.6166 64.1139 78.0303C65.8274 80.4259 68.3431 82.2044 71.205 83.0029C71.2779 83.0392 71.3873 83.0392 71.4785 83.0392Z" fill="#9063CD"/>
                                    <path d="M70.1302 83.9102C70.4766 83.9102 70.7865 83.6925 70.8776 83.3477C70.987 82.9302 70.75 82.5128 70.349 82.3858C64.1693 80.6436 62.7839 74.7091 62.7839 74.6365C62.6927 74.2191 62.2735 73.9469 61.8542 74.0376C61.4349 74.1283 61.1615 74.5458 61.2527 74.9632C61.3073 75.2354 62.8568 81.8595 69.9297 83.8558C69.9844 83.8921 70.0573 83.9102 70.1302 83.9102Z" fill="#FDDA24"/>
                                    <path d="M61.5795 71.6059C61.5977 71.6059 61.6159 71.6059 61.6159 71.6059C62.0534 71.5878 62.3816 71.2248 62.3451 70.7892C62.3086 70.0452 62.3633 68.6296 62.6732 68.0488C62.8738 67.6677 62.7279 67.1959 62.3633 66.9962C61.9805 66.7966 61.5065 66.9418 61.306 67.3048C60.6862 68.4481 60.7774 70.6259 60.7956 70.8618C60.8321 71.2792 61.1602 71.6059 61.5795 71.6059Z" fill="#FDDA24"/>
                                    <path d="M78.4232 93.6019H82.707L79.7539 107.267H63.4206L63.8399 105.307C65.3347 98.4838 71.3867 93.6019 78.4232 93.6019Z" fill="#2C2A29"/>
                                </svg>
                                <h4 class="bc-login__title-terminos">Términos y Condiciones</h4>
                                <p class="bc-login__bodyTerminos">
                                Al iniciar sesión en este sitio aceptas <a href="https://www.grupobancolombia.com/tu360/terminos-y-condiciones" target="_blank" class="bc-login__link">Términos y condiciones y la Política de Habeas Data y Tratamiento de Datos Personales</a>
                                </p>
                                <!--<h4 class="bc-login__title">Ingresa a Tu360</h4>-->
                                <!-- <p class="bc-login__body">
                                Cuando hagas CLIC en el botón, se abrirá otra ventana para tener una experiencia completa y personalizada.
                                </p>-->
                            </div>
                        `);
                        $(".bc-login:not(:first)").remove();
                        $("#vtexIdUI-custom-oauth > p").html("INICIAR SESIÓN");
                        $("#vtexIdUI-custom-oauth").removeClass().addClass("bc-login__submit bc-btn-primary terminosbtn");

                        const urlParams = new URLSearchParams(window.location.search);
                        const jws = urlParams.get("jws");

                        if (jws) $("#vtexIdUI-custom-oauth").trigger("click");
                    }
                }
            }
        };

        const storeDataMutationObserver = new MutationObserver(storeDataMutationCallback);
        storeDataMutationObserver.observe(document.body, { childList: true });
    };

    return { init };
})();

$(document).ready(generalFunc.init);

$(document).on("BC-Header-Rendered", () => {
    const user = UserServices.getUserData();
    if (user && user.isUserDefined) {
        const firstWord = !user.firstName ? "TU360" : user.firstName.replace(/ .*/, "");
        const widthDocument = $(document).width();
        if (widthDocument > 768) {
            $(".profile-content").addClass("showOptions");
            $(".button-profile").text(`HOLA, ${firstWord}`);
            // Masking data for glia
            $(".button-profile").addClass("sm_cobrowsing_masked_field");
            $(".button-profile").append('<i class="icon-chevron-down"></i>');
            $(".button-close-session-navbar").on("click", logout);
            $('.button-profile .icon-chevron-down').css('margin-left', '10px');
            let btnProfileWdt = $('.button-profile').innerWidth();
            $('.menu-profile').css('width', btnProfileWdt);
            $('.button-close-session-navbar').css({'width': btnProfileWdt, 'font-size' : '16px !important', 'text-align' : 'left'});
        } else {
            $(".button-profile").text("CERRAR SESIÓN TU360");
            $(".button-profile").on("click", logout);
        }
    } else {
        $(".profile-content").removeClass("showOptions");
        $(".button-profile").on("click", login);
    }
});

// Comprueba qué navegador es
let browserName = (function () {
    const test = function (regexp) {
        return regexp.test(window.navigator.userAgent);
    };
    switch (true) {
        case test(/edge/i):
            return "edge";
        case test(/opr/i):
            return "opera";
        case test(/chrome/i):
            return "chrome";
        case test(/trident/i):
            return "ie";
        case test(/firefox/i):
            return "firefox";
        case test(/safari/i):
            return "safari";
        default:
            return "other";
    }
})();

if (browserName === "ie") {
    $(window).load(() => {
        const handleClose = () => {
            $(".bc-ieModal__wrapper").addClass("hidden");
            $("body").removeClass("ovh");
        };
        $("body").addClass("ovh");
        $("body").append(
            `<div class="ieModal bc-ieModal__wrapper">
            <div class="ieModalOpt bc-ieModal">
            <p><img src="/arquivos/iconConfirmation.png" /></p>
            <title>Tu navegador no es compatible</title>
            <p class="ieModalText">Para asegurar una mejor experiencia en TU360Movilidad, te recomendamos hacer uso de otro navegador 
            <strong>(Chrome, Safari, Edge o Firefox)</strong>
            </p>
            <p><button class="bc-btn-primary close-modal-btn">Continuar</button></p>
            <span class="close-modal fenix-icon-error js-toggle-modal" data-modal="closeModal"></span>
            </div>
        </div>`
        );

        $(".close-modal").click((e) => {
            handleClose();
            e.stopPropagation();
        });

        $(".close-modal-btn").click((e) => {
            handleClose();
            e.stopPropagation();
        });

        let modal = document.getElementsByClassName("bc-ieModal__wrapper")[0];
        window.onclick = (e) => {
            if (e.target === modal) {
                handleClose();
                e.stopPropagation();
            }
        };
    });
}